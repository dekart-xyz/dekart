name: Push to main

on:
  push:
    branches: [main]


jobs:
  flavour:
    uses: ./.github/workflows/flavour.yaml

  changes:
    needs: [flavour]
    if: startsWith(github.head_ref, 'release') != true
    uses: ./.github/workflows/changes.yaml
    permissions:
      pull-requests: read
      contents: read

  node_tests:
    needs: [changes]
    uses: ./.github/workflows/node_test.yaml
    secrets: inherit

  go_tests:
    needs: [changes]
    uses: ./.github/workflows/go_test.yaml
    secrets: inherit
  build_e2e:
    needs: [flavour, changes]
    uses: ./.github/workflows/build.yaml
    with:
      target:    ${{ needs.flavour.outputs.target }}
      build_app: false
      build_e2e: true
    permissions:
      contents: read
      packages: write
    secrets: inherit
  e2e_tests:
    needs: [build_e2e, flavour]
    uses: ./.github/workflows/e2e.yaml
    with:
      target: ${{ needs.flavour.outputs.target }}
    permissions:
      contents: read
      packages: write
    secrets: inherit
  build_cloud:
    needs: [flavour, changes, build_e2e]
    if: needs.flavour.outputs.is_cloud == 'true'
    uses: ./.github/workflows/build.yaml
    with:
      target:    ${{ needs.flavour.outputs.target }}
      build_app: true
      build_e2e: false
    permissions:
      contents: read
      packages: write
    secrets: inherit
  create_pulumi_pr:
    if: needs.flavour.outputs.is_cloud == 'true'
    needs: [e2e_tests, go_tests, node_tests, build_cloud]
    uses: ./.github/workflows/create-pulumi-pr.yaml
    with:
      app_image: ${{ needs.build_cloud.outputs.app_image }}
    permissions:
      contents: write
      pull-requests: write
    secrets: inherit

